version: '3.8'

services:
  app:
    image: avalance-tech:latest
    build:
      context: .
      dockerfile: Dockerfile
    container_name: avalance-app
    restart: unless-stopped
    user: "nodejs"
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - PORT=3000
      - MONGODB_URI=${MONGODB_URI}
      - FROM_EMAIL=info@avalance-resources.online
      - TO_EMAIL=avalancetechpartner@gmail.com
      - JWT_EXPIRES_IN=30d
      - SMTP_HOST=smtp.gmail.com
      - SMTP_PORT=587
      - SMTP_USER=info@avalance-resources.online
      - EMAIL_FROM=info@avalance-resources.online
      - ADMIN_EMAIL=admin@avalance-resources.online
      - PM2_HOME=/home/nodejs/.pm2
      - NPM_CONFIG_PREFIX=/home/nodejs/.npm
      - NODE_CONFIG_DIR=/app/config
    secrets:
      - jwt_secret
      - sendgrid_api_key
      - smtp_pass
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    volumes:
      - ./logs:/app/logs
      - ./public/uploads:/app/public/uploads
      - pm2-data:/home/nodejs/.pm2
    tmpfs:
      - /tmp
      - /run
    networks:
      - app-network
    entrypoint: ["/app/load-secrets.sh", "/app/start.sh"]

networks:
  app-network:
    driver: bridge

volumes:
  pm2-data:
    driver: local

secrets:
  jwt_secret:
    file: ./secrets/jwt_secret.txt
  sendgrid_api_key:
    file: ./secrets/sendgrid_api_key.txt
  smtp_pass:
    file: ./secrets/smtp_pass.txt

# To use this configuration:
# 1. Create a .env file in the project root with required variables
# 2. Run: docker-compose up -d
# 3. Access the app at http://localhost:3000
# 4. Access MongoDB Express at http://localhost:8081
